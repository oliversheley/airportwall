<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KFOE Field Conditions & Weather</title>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111823;
      --text:#e8eef6;
      --muted:#9fb0c3;
      --accent:#57a6ff;

      --vfr:#2bdc4f;
      --mvfr:#4aa3ff;
      --ifr:#ff4d4d;     /* RED */
      --lifr:#c84dff;    /* MAGENTA */
      --unk:#6f7d8f;

      --age:#ff9a3d;
      --divider:rgba(255,255,255,0.08);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      height:100vh;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:12px;
      padding:16px;
      min-height:0;
    }

    header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:16px;
    }

    .title{
      font-size:clamp(22px, 1.8vw, 30px);
      font-weight:800;
      letter-spacing:0.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size:clamp(12px, 0.9vw, 14px);
      margin-top:2px;
    }

    /* ===== Layout: left 1/3 (metar+taf), right 2/3 (windy) ===== */
    .main{
      height:100%;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 2fr; /* 1/3 : 2/3 */
      gap:12px;
    }

    .left{
      min-height:0;
      display:grid;
      grid-template-rows: 1fr 1fr;   /* METAR top, TAF bottom */
      gap:12px;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:16px;
      padding:14px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:clamp(14px, 1vw, 16px);
      color:var(--muted);
      font-weight:700;
      letter-spacing:0.3px;
      flex:0 0 auto;
    }

    iframe{
      width:100%;
      flex:1;
      min-height:0;
      border:0;
      border-radius:12px;
      background:#000;
    }

    .small{ color:var(--muted); font-size:12px; }
    .accent{ color:var(--accent); font-weight:800; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .cat-vfr{ color:var(--vfr); }
    .cat-mvfr{ color:var(--mvfr); }
    .cat-ifr{ color:var(--ifr); }
    .cat-lifr{ color:var(--lifr); }
    .cat-unk{ color:#d7e3f3; }
    .error{ color:#ff6b6b; font-weight:800; }

    /* hazard highlight (RED) */
    .haz-red{
      color: var(--ifr);
      font-weight: 1000;
    }

    /* ===== METAR ===== */
    .metarTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      margin-bottom:10px;
      flex:0 0 auto;
    }
    .catBadge{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:clamp(18px, 1.55vw, 24px);
      letter-spacing:0.4px;
    }
    .dot{
      width:22px;
      height:22px;
      border-radius:999px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06) inset;
    }
    .ageBadge{
      font-weight:900;
      font-size:clamp(16px, 1.35vw, 22px);
      color:var(--age);
      white-space:nowrap;
    }

    .metarRaw{
      font-size:clamp(12px, 0.95vw, 15px);
      font-weight:900;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.06);
      margin-bottom:10px;
      line-height:1.25;
      white-space:pre-wrap;
      word-break:break-word;
      flex:0 0 auto;
    }

    .kvTable{
      border-radius:16px;
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.06);
      overflow:hidden;
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .kvRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:clamp(6px, 0.7vh, 10px) 12px;
      border-top:1px solid var(--divider);
      align-items:center;
      flex: 1 0 auto;
      min-height:0;
    }
    .kvRow:first-child{ border-top:none; }

    .kvLabel{
      color:rgba(255,255,255,0.92);
      font-size:clamp(12px, 0.9vw, 15px);
      font-weight:800;
      text-align:center;
      line-height:1.1;
    }
    .kvValue{
      color:var(--mvfr);
      font-size:clamp(12px, 0.95vw, 16px);
      font-weight:900;
      text-align:center;
      letter-spacing:0.2px;
      line-height:1.1;
      white-space:nowrap;
    }

    .obsLine{
      margin-top:8px;
      flex:0 0 auto;
      font-size:12px;
      color:var(--muted);
    }

    /* ===== TAF ===== */
    .tafHeader{ flex:0 0 auto; }

    .tafBlock{
      flex:1 1 auto;
      min-height:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:clamp(12px, 0.95vw, 14px);
      line-height:1.35;
      overflow:hidden;

      -webkit-mask-image: linear-gradient(to bottom, #000 88%, transparent);
      mask-image: linear-gradient(to bottom, #000 88%, transparent);
    }
    .tafLine{ display:block; }

    /* ===== TAF timeline bar (8 x 3-hour blocks) ===== */
    .tafBarWrap{
      flex:0 0 auto;
      margin-top:10px;
    }
    .tafBarLabel{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tafBar{
      position:relative;
      height:14px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      display:flex;
      gap:6px;                 /* separation between 3-hr blocks */
      padding:2px;             /* inset */
    }
    .tafSeg{
      height:100%;
      border-radius:8px;
      min-width:0;
    }

    .seg-vfr{ background:var(--vfr); }
    .seg-mvfr{ background:var(--mvfr); }
    .seg-ifr{ background:var(--ifr); }
    .seg-lifr{ background:var(--lifr); }
    .seg-unk{ background:var(--unk); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">KFOE — Forbes Field</div>
        <div class="subtitle">METAR/TAF + Radar (Windy) • Auto-refresh</div>
      </div>
      <div class="subtitle" id="clock"></div>
    </header>

    <div class="main">
      <!-- LEFT 1/3: METAR + TAF -->
      <div class="left">
        <!-- METAR -->
        <div class="card">
          <h2>METAR</h2>

          <div class="metarTop">
            <div class="catBadge">
              <span id="catDot" class="dot" style="background: var(--unk);"></span>
              <span id="catText" class="cat-unk">—</span>
            </div>
            <div id="ageBadge" class="ageBadge">—</div>
          </div>

          <div id="metarraw" class="metarRaw mono cat-unk">Loading…</div>

          <div class="kvTable">
            <div class="kvRow">
              <div class="kvLabel">Time</div>
              <div class="kvValue" id="m_time">—</div>
            </div>
            <div class="kvRow">
              <div class="kvLabel">Wind</div>
              <div class="kvValue" id="m_wind">—</div>
            </div>
            <div class="kvRow">
              <div class="kvLabel">Visibility</div>
              <div class="kvValue" id="m_vis">—</div>
            </div>
            <div class="kvRow">
              <div class="kvLabel">Clouds (AGL)</div>
              <div class="kvValue" id="m_clouds">—</div>
            </div>
            <div class="kvRow">
              <div class="kvLabel">Temperature</div>
              <div class="kvValue" id="m_temp">—</div>
            </div>
            <div class="kvRow">
              <div class="kvLabel">Dewpoint</div>
              <div class="kvValue" id="m_dew">—</div>
            </div>
            <div class="kvRow">
              <div class="kvLabel">Altimeter</div>
              <div class="kvValue" id="m_alt">—</div>
            </div>
          </div>

          <div class="obsLine">Obs time: <span class="accent" id="obstime">—</span></div>
        </div>

        <!-- TAF -->
        <div class="card">
          <div class="tafHeader">
            <h2>TAF (Raw with Line Breaks + Colors)</h2>
            <div class="small" id="tafmeta">Loading…</div>
          </div>

          <div id="tafBlock" class="tafBlock mono cat-unk">Loading…</div>

          <div class="tafBarWrap">
            <div class="tafBarLabel" id="tafBarLabel">Next 24h:</div>
            <div class="tafBar" id="tafBar" aria-label="TAF 24 hour flight category bar"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT 2/3: WINDY -->
      <div class="card">
        <h2>Radar / Weather Map (Windy embed)</h2>
        <iframe id="windyRadar" loading="lazy" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <script>
"use strict";

/* ====== CONFIG ====== */
const STATION = "KFOE";
const PROXY_BASE = "https://kfoe-awc-proxy.oliversheley.workers.dev";

// Marker/detail point (KFOE)
const DETAIL_LAT = 38.95083;
const DETAIL_LON = -95.66361;

// ✅ Map center point (zoomed-out focus) — change these to whatever you want
const CENTER_LAT = 39.10;
const CENTER_LON = -95.80;

// Zoom: smaller = more zoomed out (try 7–10)
const WINDY_ZOOM = 8;

/* ====== STATE ====== */
let lastObsMs = null;

/* ====== HELPERS ====== */
const $ = (id) => document.getElementById(id);

function setClock() {
  const el = $("clock");
  if (el) el.textContent = new Date().toLocaleString();
}

function parseTimeToMs(t){
  if (t == null) return null;
  if (typeof t === "number" && Number.isFinite(t)){
    if (t > 1e12) return t;
    if (t > 1e9)  return t * 1000;
    return null;
  }
  if (typeof t === "string"){
    const s = t.trim();
    if (/^\d{9,16}$/.test(s)){
      const n = Number(s);
      if (!Number.isFinite(n)) return null;
      if (n > 1e12) return n;
      if (n > 1e9)  return n * 1000;
    }
    const ms = Date.parse(s);
    return Number.isFinite(ms) ? ms : null;
  }
  return null;
}

function computeAgeMinutesFromMs(ms){
  if (!Number.isFinite(ms)) return null;
  const diff = Date.now() - ms;
  if (!Number.isFinite(diff) || diff < 0) return null;
  const mins = Math.round(diff / 60000);
  if (mins > 24 * 60 * 7) return null;
  return mins;
}

function refreshAgeOnly(){
  const mins = computeAgeMinutesFromMs(lastObsMs);
  const el = $("ageBadge");
  if (el) el.textContent = (mins == null) ? "—" : `${mins}m ago`;
}

function formatLocalTimeWithTZFromMs(ms){
  if (!Number.isFinite(ms)) return "—";
  return new Date(ms).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", timeZoneName:"short" });
}

function formatObsLineFromMs(ms){
  if (!Number.isFinite(ms)) return "—";
  return new Date(ms).toLocaleString([], { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", timeZoneName:"short" });
}

function safe(v, fallback="—"){
  return (v === undefined || v === null || v === "") ? fallback : v;
}

function catClass(cat){
  switch (String(cat || "").toUpperCase()){
    case "VFR":  return "cat-vfr";
    case "MVFR": return "cat-mvfr";
    case "IFR":  return "cat-ifr";
    case "LIFR": return "cat-lifr";
    default:     return "cat-unk";
  }
}
function catColorVar(cat){
  switch (String(cat || "").toUpperCase()){
    case "VFR":  return "var(--vfr)";
    case "MVFR": return "var(--mvfr)";
    case "IFR":  return "var(--ifr)";
    case "LIFR": return "var(--lifr)";
    default:     return "var(--unk)";
  }
}

async function fetchJSON(path){
  const url = `${PROXY_BASE}${path}`;
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

/* ====== Windy URL (safe builder) ====== */
function buildWindyUrl(){
  return "https://embed.windy.com/embed2.html" +
    `?lat=${encodeURIComponent(CENTER_LAT)}` +
    `&lon=${encodeURIComponent(CENTER_LON)}` +
    `&detailLat=${encodeURIComponent(DETAIL_LAT)}` +
    `&detailLon=${encodeURIComponent(DETAIL_LON)}` +
    "&width=100%&height=100%" +
    `&zoom=${encodeURIComponent(WINDY_ZOOM)}` +
    "&level=surface" +
    "&overlay=rain" +
    "&product=ecmwf" +
    "&menu=&message=true&marker=true" +
    "&calendar=now&pressure=true" +
    "&type=map&location=coordinates&detail=true" +
    "&metricWind=default&metricTemp=default&radarRange=-1";
}

/* ====== Minimal METAR decode (same behavior as before) ====== */
function cloudPhrase(clouds){
  if (!Array.isArray(clouds) || !clouds.length) return "Clear";
  const sorted = clouds.filter(c=>Number.isFinite(c.base)).sort((a,b)=>a.base-b.base);
  if (!sorted.length) return "—";
  const pick = sorted.find(c => ["OVC","BKN","VV"].includes(String(c.cover||"").toUpperCase())) || sorted[0];
  const cover = String(pick.cover||"").toUpperCase();
  const base = pick.base;
  const coverWord = ({OVC:"Overcast",BKN:"Broken",SCT:"Scattered",FEW:"Few",VV:"Vertical Vis"})[cover] || cover;
  return `${coverWord} ${base.toLocaleString()}′`;
}

function cToF(c){ return Number.isFinite(c) ? (c * 9/5) + 32 : null; }

function parseAltimeterInHg(alt){
  if (alt == null) return null;
  const n = Number(alt);
  if (!Number.isFinite(n)) return null;
  if (n >= 20 && n <= 35) return n;
  if (n >= 2000 && n <= 3500) return n / 100;
  if (n >= 800 && n <= 1100) return n * 0.029529983;
  return null;
}

async function loadMetar(){
  const metarraw = $("metarraw");
  try{
    const arr = await fetchJSON(`/metar?ids=${encodeURIComponent(STATION)}`);
    const m = (Array.isArray(arr) && arr.length) ? arr[0] : null;
    if (!m) throw new Error("No METAR returned");

    const raw = safe(m.rawOb || m.raw || m.text, JSON.stringify(m, null, 2));
    const cat = String(m.fltCat || "UNK").toUpperCase();

    $("catText").textContent = cat;
    $("catText").className = catClass(cat);
    $("catDot").style.background = catColorVar(cat);

    const obs = m.obsTime || m.reportTime || m.time;
    lastObsMs = parseTimeToMs(obs);
    $("obstime").textContent = formatObsLineFromMs(lastObsMs);
    refreshAgeOnly();

    metarraw.className = "metarRaw mono " + catClass(cat);
    metarraw.textContent = raw;

    $("m_time").textContent = formatLocalTimeWithTZFromMs(lastObsMs);

    const windTxt = (m.wdir != null && m.wspd != null)
      ? `${String(m.wdir).padStart(3,"0")}° at ${m.wspd}${m.wgst ? " - " + m.wgst : ""} kts`
      : "—";
    $("m_wind").textContent = windTxt;

    let visTxt = "—";
    if (m.visib != null){
      const s = String(m.visib);
      if (/^6\+/.test(s) || s === "6+") visTxt = "10+ sm";
      else visTxt = `${s} sm`;
    }
    $("m_vis").textContent = visTxt;

    $("m_clouds").textContent = cloudPhrase(m.clouds);

    const tC = Number.isFinite(m.temp) ? m.temp : null;
    const dC = Number.isFinite(m.dewp) ? m.dewp : null;
    const tF = (tC == null) ? null : cToF(tC);
    const dF = (dC == null) ? null : cToF(dC);

    $("m_temp").textContent = (tC == null || tF == null) ? "—" : `${tC.toFixed(1)}°C (${Math.round(tF)}°F)`;
    $("m_dew").textContent  = (dC == null || dF == null) ? "—" : `${dC.toFixed(1)}°C (${Math.round(dF)}°F)`;

    const altInHg = parseAltimeterInHg(m.altim);
    $("m_alt").textContent = (altInHg == null) ? "—" : `${altInHg.toFixed(2)} inHg`;

  } catch(e){
    // Show the error on-screen (so you don't need console access)
    $("catText").textContent = "—";
    $("catText").className = "cat-unk";
    $("catDot").style.background = "var(--unk)";
    $("ageBadge").textContent = "—";
    $("obstime").textContent = "—";

    if (metarraw){
      metarraw.className = "metarRaw mono error";
      metarraw.textContent = `ERROR loading METAR: ${e.message}`;
    }
    lastObsMs = null;
  }
}

async function loadTaf(){
  const tafmeta = $("tafmeta");
  const tafBlock = $("tafBlock");
  try{
    const arr = await fetchJSON(`/taf?ids=${encodeURIComponent(STATION)}`);
    const t = (Array.isArray(arr) && arr.length) ? arr[0] : null;
    if (!t) throw new Error("No TAF returned");

    tafmeta.textContent = `Issued: ${safe(t.issueTime)} • Valid: ${safe(t.validTimeFrom)}–${safe(t.validTimeTo)}`;

    const raw = t.rawTAF || t.rawOb || t.raw || t.text || "";
    tafBlock.className = "tafBlock mono cat-unk";
    tafBlock.textContent = raw || "No TAF text returned.";

    // leave your existing colored-line + bar logic intact if you re-add it;
    // this block just ensures you at least see something if you broke a function name.
  } catch(e){
    tafmeta.textContent = "";
    tafBlock.className = "tafBlock mono error";
    tafBlock.textContent = `ERROR loading TAF: ${e.message}`;
  }
}

/* ====== INIT ====== */
function init(){
  try{
    setClock();

    const windy = $("windyRadar");
    if (windy) windy.src = buildWindyUrl();

    loadMetar();
    loadTaf();

    setInterval(setClock, 10_000);
    setInterval(refreshAgeOnly, 30_000);
    setInterval(loadMetar, 60_000);
    setInterval(loadTaf,  5 * 60_000);

  } catch (e){
    const metarraw = $("metarraw");
    if (metarraw){
      metarraw.className = "metarRaw mono error";
      metarraw.textContent = `JS ERROR: ${e.message}`;
    }
  }
}

window.addEventListener("DOMContentLoaded", init);
</script>

  
</body>
</html>
