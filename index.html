<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KFOE Field Conditions & Weather</title>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111823;
      --text:#e8eef6;
      --muted:#9fb0c3;
      --accent:#57a6ff;

      --vfr:#2bdc4f;
      --mvfr:#4aa3ff;
      --ifr:#ff4d4d;
      --lifr:#c84dff;
      --unk:#d7e3f3;

      --age:#ff9a3d;
      --divider:rgba(255,255,255,0.08);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; } /* no page scrolling */
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      height:100vh;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:12px;
      padding:16px;
      min-height:0;
    }

    header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:16px;
    }

    .title{
      font-size:clamp(22px, 1.8vw, 30px);
      font-weight:800;
      letter-spacing:0.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size:clamp(12px, 0.9vw, 14px);
      margin-top:2px;
    }

    /* ======= MAIN EQUAL-SHARE GRID ======= */
    .grid{
      height:100%;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;     /* equal vertical shares */
      gap:12px;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:16px;
      padding:14px;
      overflow:hidden; /* never show scrollbars inside cards */
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      min-height:0;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:clamp(14px, 1vw, 16px);
      color:var(--muted);
      font-weight:700;
      letter-spacing:0.3px;
    }

    .metarCard{ grid-column:1; grid-row:1; display:flex; flex-direction:column; min-height:0; }
    .tafCard  { grid-column:2; grid-row:1; display:flex; flex-direction:column; min-height:0; }
    .radarCard{ grid-column:1 / span 2; grid-row:2; display:flex; flex-direction:column; min-height:0; }

    iframe{
      width:100%;
      flex:1;
      min-height:0;
      border:0;
      border-radius:12px;
      background:#000;
    }

    .small{ color:var(--muted); font-size:12px; }
    .accent{ color:var(--accent); font-weight:800; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Category classes */
    .cat-vfr{ color:var(--vfr); }
    .cat-mvfr{ color:var(--mvfr); }
    .cat-ifr{ color:var(--ifr); }
    .cat-lifr{ color:var(--lifr); }
    .cat-unk{ color:var(--unk); }
    .error{ color:#ff6b6b; font-weight:800; }

    /* ===== METAR “app” look (tightened) ===== */
    .metarTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      margin-bottom:10px;
      flex:0 0 auto;
    }

    .catBadge{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:clamp(18px, 1.6vw, 26px);
      letter-spacing:0.4px;
    }
    .dot{
      width:22px;
      height:22px;
      border-radius:999px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06) inset;
    }
    .ageBadge{
      font-weight:900;
      font-size:clamp(16px, 1.4vw, 24px);
      color:var(--age);
      white-space:nowrap;
    }

    .metarRaw{
      font-size:clamp(14px, 1.25vw, 20px);
      font-weight:900;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.06);
      margin-bottom:12px;
      line-height:1.25;
      white-space:pre-wrap;
      word-break:break-word;
      flex:0 0 auto;
    }

    .kvTable{
      border-radius:16px;
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.06);
      overflow:hidden;
      flex:1 1 auto;
      min-height:0;
    }

    .kvRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:clamp(8px, 1vh, 12px) 14px; /* tighter */
      border-top:1px solid var(--divider);
      align-items:center;
    }
    .kvRow:first-child{ border-top:none; }

    .kvLabel{
      color:rgba(255,255,255,0.92);
      font-size:clamp(14px, 1.2vw, 20px);
      font-weight:800;
      text-align:center;
    }
    .kvValue{
      color:var(--mvfr);
      font-size:clamp(16px, 1.35vw, 24px);
      font-weight:900;
      text-align:center;
      letter-spacing:0.2px;
    }

    .obsLine{
      margin-top:8px;
      flex:0 0 auto;
      font-size:12px;
      color:var(--muted);
    }

    /* ===== TAF (no scrolling; fades out) ===== */
    .tafHeader{ flex:0 0 auto; }
    .tafBlock{
      flex:1 1 auto;
      min-height:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:clamp(12px, 1.05vw, 15px);
      line-height:1.35;
      overflow:hidden; /* no scrolling */
      padding-right:4px;

      /* fade at bottom so overflow feels intentional */
      -webkit-mask-image: linear-gradient(to bottom, #000 85%, transparent);
      mask-image: linear-gradient(to bottom, #000 85%, transparent);
    }
    .tafLine{ display:block; }

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">KFOE — Forbes Field</div>
        <div class="subtitle">METAR/TAF + Radar (Windy) • Auto-refresh</div>
      </div>
      <div class="subtitle" id="clock"></div>
    </header>

    <div class="grid">
      <!-- METAR -->
      <div class="card metarCard">
        <h2>METAR</h2>

        <div class="metarTop">
          <div class="catBadge">
            <span id="catDot" class="dot" style="background: var(--unk);"></span>
            <span id="catText" class="cat-unk">—</span>
          </div>
          <div id="ageBadge" class="ageBadge">—</div>
        </div>

        <div id="metarraw" class="metarRaw mono cat-unk">Loading…</div>

        <div class="kvTable">
          <div class="kvRow">
            <div class="kvLabel">Time</div>
            <div class="kvValue" id="m_time">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Wind</div>
            <div class="kvValue" id="m_wind">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Visibility</div>
            <div class="kvValue" id="m_vis">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Clouds (AGL)</div>
            <div class="kvValue" id="m_clouds">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Temperature</div>
            <div class="kvValue" id="m_temp">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Dewpoint</div>
            <div class="kvValue" id="m_dew">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Altimeter</div>
            <div class="kvValue" id="m_alt">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Humidity</div>
            <div class="kvValue" id="m_rh">—</div>
          </div>
          <div class="kvRow">
            <div class="kvLabel">Density Altitude</div>
            <div class="kvValue" id="m_da">—</div>
          </div>
        </div>

        <div class="obsLine">Obs time: <span class="accent" id="obstime">—</span></div>
      </div>

      <!-- TAF -->
      <div class="card tafCard">
        <div class="tafHeader">
          <h2>TAF (Raw with Line Breaks + Colors)</h2>
          <div class="small" id="tafmeta">Loading…</div>
        </div>

        <div id="tafBlock" class="tafBlock mono cat-unk">Loading…</div>
      </div>

      <!-- Radar -->
      <div class="card radarCard">
        <h2>Radar / Weather Map (Windy embed)</h2>
        <iframe id="windy" loading="lazy" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    // ====== CONFIG ======
    const STATION = "KFOE";
    const PROXY_BASE = "https://kfoe-awc-proxy.oliversheley.workers.dev";

    // KFOE field elevation for DA calc (adjust if desired)
    const FIELD_ELEV_FT = 1033;

    const LAT = 38.95083;
    const LON = -95.66361;

    const WINDY_URL =
      "https://embed.windy.com/embed2.html" +
      `?lat=${encodeURIComponent(LAT)}` +
      `&lon=${encodeURIComponent(LON)}` +
      `&detailLat=${encodeURIComponent(LAT)}` +
      `&detailLon=${encodeURIComponent(LON)}` +
      "&width=100%&height=100%" +
      "&zoom=9&level=surface" +
      "&overlay=rain" +
      "&product=ecmwf" +
      "&menu=&message=true&marker=true" +
      "&calendar=now&pressure=true" +
      "&type=map&location=coordinates&detail=true" +
      "&metricWind=default&metricTemp=default&radarRange=-1";

    // ====== STATE ======
    let lastObsMs = null;

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);

    function setClock(){ $("clock").textContent = new Date().toLocaleString(); }

    function safe(v, fallback="—"){ return (v === undefined || v === null || v === "") ? fallback : v; }

    function catClass(cat){
      switch (String(cat || "").toUpperCase()){
        case "VFR":  return "cat-vfr";
        case "MVFR": return "cat-mvfr";
        case "IFR":  return "cat-ifr";
        case "LIFR": return "cat-lifr";
        default:     return "cat-unk";
      }
    }
    function catColorVar(cat){
      switch (String(cat || "").toUpperCase()){
        case "VFR":  return "var(--vfr)";
        case "MVFR": return "var(--mvfr)";
        case "IFR":  return "var(--ifr)";
        case "LIFR": return "var(--lifr)";
        default:     return "var(--unk)";
      }
    }

    // Robust time parsing: ISO string OR unix seconds OR unix ms
    function parseTimeToMs(t){
      if (t == null) return null;

      if (typeof t === "number" && Number.isFinite(t)){
        if (t > 1e12) return t;           // ms
        if (t > 1e9)  return t * 1000;    // seconds
        return null;
      }

      if (typeof t === "string"){
        const s = t.trim();

        if (/^\d{9,16}$/.test(s)){
          const n = Number(s);
          if (!Number.isFinite(n)) return null;
          if (n > 1e12) return n;
          if (n > 1e9)  return n * 1000;
        }

        const ms = Date.parse(s);
        return Number.isFinite(ms) ? ms : null;
      }

      return null;
    }

    function computeAgeMinutesFromMs(ms){
      if (!Number.isFinite(ms)) return null;
      const diff = Date.now() - ms;
      if (!Number.isFinite(diff) || diff < 0) return null;
      const mins = Math.round(diff / 60000);
      if (mins > 24 * 60 * 7) return null; // > 7 days => show "—"
      return mins;
    }

    function refreshAgeOnly(){
      const mins = computeAgeMinutesFromMs(lastObsMs);
      $("ageBadge").textContent = (mins == null) ? "—" : `${mins}m ago`;
    }

    function formatLocalTimeWithTZFromMs(ms){
      if (!Number.isFinite(ms)) return "—";
      return new Date(ms).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", timeZoneName:"short" });
    }

    function formatObsLineFromMs(ms){
      if (!Number.isFinite(ms)) return "—";
      return new Date(ms).toLocaleString([], { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", timeZoneName:"short" });
    }

    function ceilingFeetFromClouds(clouds){
      if (!Array.isArray(clouds) || !clouds.length) return null;
      const candidates = clouds
        .filter(c => ["BKN","OVC","VV"].includes(String(c.cover||"").toUpperCase()) && Number.isFinite(c.base))
        .sort((a,b)=>a.base-b.base);
      return candidates.length ? candidates[0].base : null;
    }

    function cloudPhrase(clouds){
      if (!Array.isArray(clouds) || !clouds.length) return "Clear";
      const sorted = clouds.filter(c=>Number.isFinite(c.base)).sort((a,b)=>a.base-b.base);
      if (!sorted.length) return "—";
      const pick = sorted.find(c => ["OVC","BKN","VV"].includes(String(c.cover||"").toUpperCase())) || sorted[0];
      const cover = String(pick.cover||"").toUpperCase();
      const base = pick.base;
      const coverWord = ({OVC:"Overcast",BKN:"Broken",SCT:"Scattered",FEW:"Few",VV:"Vertical Vis"})[cover] || cover;
      return `${coverWord} ${base.toLocaleString()}′`;
    }

    function cToF(c){ return Number.isFinite(c) ? (c * 9/5) + 32 : null; }

    function relHumidityPct(tempC, dewC){
      if (!Number.isFinite(tempC) || !Number.isFinite(dewC)) return null;
      const a=17.625, b=243.04;
      const sat=Math.exp((a*tempC)/(b+tempC));
      const act=Math.exp((a*dewC)/(b+dewC));
      const rh=(act/sat)*100;
      return Math.max(0, Math.min(100, rh));
    }

    // altimeter might be inHg, hundredths inHg, or hPa
    function parseAltimeterInHg(alt){
      if (alt == null) return null;
      const n = Number(alt);
      if (!Number.isFinite(n)) return null;

      if (n >= 20 && n <= 35) return n;
      if (n >= 2000 && n <= 3500) return n / 100;
      if (n >= 800 && n <= 1100) return n * 0.029529983;
      return null;
    }

    function densityAltitudeFt(fieldElevFt, altimInHg, tempC){
      if (!Number.isFinite(fieldElevFt) || !Number.isFinite(altimInHg) || !Number.isFinite(tempC)) return null;
      const pa = fieldElevFt + (29.92 - altimInHg) * 1000;
      const isa = 15 - 2 * (pa / 1000);
      return pa + 120 * (tempC - isa);
    }

    function fmtFeet(ft){
      if (!Number.isFinite(ft)) return "—";
      return `${Math.round(ft).toLocaleString()}′`;
    }

    async function fetchJSON(path){
      const url = `${PROXY_BASE}${path}`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    // TAF line breaks (raw style)
    function tafRawToLines(rawTAF){
      const s = String(rawTAF || "").trim();
      if (!s) return [];
      const normalized = s
        .replace(/^TAF\s+/i, "TAF ")
        .replace(/\s+(FM\d{6})/g, "\n$1")
        .replace(/\s+(TEMPO)/g, "\n$1")
        .replace(/\s+(BECMG)/g, "\n$1")
        .replace(/\s+(PROB\d{2})/g, "\n$1");
      return normalized.split("\n").map(x=>x.trim()).filter(Boolean);
    }

    function visToNumber(vis){
      if (vis == null) return null;
      if (typeof vis === "number") return Number.isFinite(vis) ? vis : null;
      if (typeof vis === "string"){
        const s = vis.trim().replace("+","");
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      }
      return null;
    }

    function flightCategoryFrom(visSM, ceilFT){
      function visCat(v){
        if (v == null) return null;
        if (v < 1) return "LIFR";
        if (v < 3) return "IFR";
        if (v <= 5) return "MVFR";
        return "VFR";
      }
      function ceilCat(c){
        if (c == null) return null;
        if (c < 500) return "LIFR";
        if (c < 1000) return "IFR";
        if (c < 3000) return "MVFR";
        return "VFR";
      }
      const a = visCat(visSM);
      const b = ceilCat(ceilFT);
      if (a && b){
        const rank={LIFR:0, IFR:1, MVFR:2, VFR:3};
        return (rank[a] < rank[b]) ? a : b;
      }
      return a || b || "UNK";
    }

    function fmtUnixLocal(unixSec){
      if (!unixSec || !Number.isFinite(unixSec)) return "—";
      const d = new Date(unixSec * 1000);
      return d.toLocaleString([], { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    // ====== LOADERS ======
    async function loadMetar(){
      const metarraw = $("metarraw");
      metarraw.className = "metarRaw mono cat-unk";

      try{
        const arr = await fetchJSON(`/metar?ids=${encodeURIComponent(STATION)}`);
        const m = (Array.isArray(arr) && arr.length) ? arr[0] : null;
        if (!m) throw new Error("No METAR returned");

        const raw = safe(m.rawOb || m.raw || m.text, JSON.stringify(m, null, 2));
        metarraw.textContent = raw;

        const cat = String(m.fltCat || "UNK").toUpperCase();
        $("catText").textContent = cat;
        $("catText").className = catClass(cat);
        $("catDot").style.background = catColorVar(cat);
        metarraw.classList.add(catClass(cat));

        const obs = m.obsTime || m.reportTime || m.time;
        lastObsMs = parseTimeToMs(obs);

        $("obstime").textContent = formatObsLineFromMs(lastObsMs);
        refreshAgeOnly();

        $("m_time").textContent = formatLocalTimeWithTZFromMs(lastObsMs);

        const windTxt = (m.wdir != null && m.wspd != null)
          ? `${String(m.wdir).padStart(3,"0")}° at ${m.wspd}${m.wgst ? " - " + m.wgst : ""} kts`
          : "—";
        $("m_wind").textContent = windTxt;

        // Vis display: show 10+ if P6SM-ish
        let visTxt = "—";
        if (m.visib != null){
          const s = String(m.visib);
          if (/^6\+/.test(s) || s === "6+") visTxt = "10+ sm";
          else visTxt = `${s} sm`;
        }
        $("m_vis").textContent = visTxt;

        $("m_clouds").textContent = cloudPhrase(m.clouds);

        const tC = Number.isFinite(m.temp) ? m.temp : null;
        const dC = Number.isFinite(m.dewp) ? m.dewp : null;
        const tF = (tC == null) ? null : cToF(tC);
        const dF = (dC == null) ? null : cToF(dC);

        $("m_temp").textContent = (tC == null || tF == null) ? "—" : `${tC.toFixed(1)}°C (${Math.round(tF)}°F)`;
        $("m_dew").textContent  = (dC == null || dF == null) ? "—" : `${dC.toFixed(1)}°C (${Math.round(dF)}°F)`;

        const altInHg = parseAltimeterInHg(m.altim);
        $("m_alt").textContent = (altInHg == null) ? "—" : `${altInHg.toFixed(2)} inHg`;

        const rh = relHumidityPct(tC, dC);
        $("m_rh").textContent = (rh == null) ? "—" : `${Math.round(rh)}%`;

        const da = densityAltitudeFt(FIELD_ELEV_FT, altInHg, tC);
        $("m_da").textContent = fmtFeet(da);

      } catch(e){
        $("catText").textContent = "—";
        $("catText").className = "cat-unk";
        $("catDot").style.background = "var(--unk)";
        $("ageBadge").textContent = "—";

        metarraw.textContent = `ERROR loading METAR: ${e.message}`;
        metarraw.className = "metarRaw mono error";

        lastObsMs = null;
        $("obstime").textContent = "—";
      }
    }

    async function loadTaf(){
      const tafmeta = $("tafmeta");
      const tafBlock = $("tafBlock");
      tafBlock.className = "tafBlock mono cat-unk";
      tafBlock.textContent = "";
      tafBlock.innerHTML = "";

      try{
        const arr = await fetchJSON(`/taf?ids=${encodeURIComponent(STATION)}`);
        const t = (Array.isArray(arr) && arr.length) ? arr[0] : null;
        if (!t) throw new Error("No TAF returned");

        tafmeta.textContent =
          `Issued: ${safe(t.issueTime)} • Valid: ${fmtUnixLocal(t.validTimeFrom)}–${fmtUnixLocal(t.validTimeTo)}`;

        const raw = t.rawTAF || t.rawOb || t.raw || t.text || "";
        const lines = tafRawToLines(raw);
        const fcsts = Array.isArray(t.fcsts) ? t.fcsts : [];

        if (!lines.length){
          tafBlock.textContent = "No TAF text returned.";
          return;
        }

        lines.forEach((line, i) => {
          const f = fcsts[i] || null;
          const visN = f ? visToNumber(f.visib) : null;
          const ceil = f ? ceilingFeetFromClouds(f.clouds) : null;
          const cat = f ? flightCategoryFrom(visN, ceil) : "UNK";

          const span = document.createElement("span");
          span.className = `tafLine ${catClass(cat)}`;
          span.textContent = line;

          tafBlock.appendChild(span);
          tafBlock.appendChild(document.createTextNode("\n"));
        });

      } catch(e){
        tafmeta.textContent = "";
        tafBlock.textContent = `ERROR loading TAF: ${e.message}`;
        tafBlock.className = "tafBlock mono error";
      }
    }

    function init(){
      setClock();
      $("windy").src = WINDY_URL;

      loadMetar();
      loadTaf();

      setInterval(setClock, 10_000);
      setInterval(refreshAgeOnly, 30_000);

      setInterval(loadMetar, 60_000);
      setInterval(loadTaf,  5 * 60_000);
    }

    init();
  </script>
</body>
</html>
