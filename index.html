<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KFOE Field Conditions & Weather</title>
  <style>
    :root {
      --bg:#0b0f14; --card:#111823; --text:#e8eef6; --muted:#9fb0c3; --accent:#57a6ff;

      /* Category colors (pilot-standard-ish) */
      --vfr:#2bdc4f;     /* green */
      --mvfr:#4aa3ff;    /* blue */
      --ifr:#ff4d4d;     /* red */
      --lifr:#c84dff;    /* magenta/purple */
      --unknown:#d7e3f3; /* default text */
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { height:100vh; display:grid; grid-template-rows:auto 1fr; gap:12px; padding:16px; }
    header { display:flex; align-items:baseline; justify-content:space-between; gap:16px; }
    .title { font-size:28px; font-weight:700; letter-spacing:0.5px; }
    .subtitle { color:var(--muted); font-size:14px; }

    .grid { height:100%; display:grid; grid-template-columns: 1.05fr 0.95fr; gap:12px; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:14px; overflow:hidden; }
    .card h2 { margin:0 0 10px 0; font-size:16px; color:var(--muted); font-weight:600; letter-spacing:0.4px; }

    .kv { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
    .pill { padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); }
    .pill .k { font-size:12px; color:var(--muted); margin-bottom:4px; }
    .pill .v { font-size:18px; font-weight:700; }

    .row { display:grid; grid-template-rows:auto 1fr; gap:10px; height:100%; }
    iframe { width:100%; height:100%; border:0; border-radius:12px; background:#000; }

    .small { color:var(--muted); font-size:12px; }
    .accent { color: var(--accent); font-weight:700; }
    .error { color:#ff6b6b; font-weight:700; }

    /* Monospace blocks */
    .mono {
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:14px;
      line-height:1.25;
    }

    /* Category classes */
    .cat-vfr { color: var(--vfr); }
    .cat-mvfr { color: var(--mvfr); }
    .cat-ifr { color: var(--ifr); }
    .cat-lifr { color: var(--lifr); }
    .cat-unknown { color: var(--unknown); }

    /* TAF lines */
    .tafLines { display:flex; flex-direction:column; gap:6px; overflow:auto; padding-right:4px; }
    .tafLine {
      padding:8px 10px;
      border-radius:12px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
    }
    .tafLine .meta { font-size:11px; color:var(--muted); margin-bottom:4px; }
    .tafLine .txt { font-weight:700; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">KFOE — Forbes Field</div>
        <div class="subtitle">METAR/TAF + Radar (Windy) • Auto-refresh</div>
      </div>
      <div class="subtitle" id="clock"></div>
    </header>

    <div class="grid">
      <!-- METAR -->
      <div class="card row">
        <div>
          <h2>METAR (Decoded Highlights + Raw)</h2>
          <div class="kv">
            <div class="pill"><div class="k">Flight Category</div><div class="v" id="fltcat">—</div></div>
            <div class="pill"><div class="k">Wind</div><div class="v" id="wind">—</div></div>
            <div class="pill"><div class="k">Visibility</div><div class="v" id="vis">—</div></div>
            <div class="pill"><div class="k">Ceiling</div><div class="v" id="cig">—</div></div>
            <div class="pill"><div class="k">Temp / Dew</div><div class="v" id="tempdew">—</div></div>
            <div class="pill"><div class="k">Altimeter</div><div class="v" id="altim">—</div></div>
          </div>
          <div class="small">Obs time: <span class="accent" id="obstime">—</span> • Age: <span class="accent" id="age">—</span></div>
        </div>

        <!-- Raw METAR (colored by category) -->
        <div id="metarraw" class="mono cat-unknown">Loading…</div>
      </div>

      <!-- TAF -->
      <div class="card row">
        <div>
          <h2>TAF (Line-by-line Category)</h2>
          <div class="small" id="tafmeta">Loading…</div>
          <div class="small" id="tafrawheader"></div>
        </div>

        <!-- TAF lines (each line colored by computed category) -->
        <div id="tafLines" class="tafLines"></div>
      </div>

      <!-- Radar -->
      <div class="card" style="grid-column: 1 / span 2; height:42vh;">
        <h2>Radar / Weather Map (Windy embed)</h2>
        <iframe id="windy" loading="lazy" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const STATION = "KFOE";
    const PROXY_BASE = "https://kfoe-awc-proxy.oliversheley.workers.dev";

    // KFOE approx coords (map center)
    const LAT = 38.95083;
    const LON = -95.66361;

    const WINDY_URL =
      "https://embed.windy.com/embed2.html" +
      `?lat=${encodeURIComponent(LAT)}` +
      `&lon=${encodeURIComponent(LON)}` +
      `&detailLat=${encodeURIComponent(LAT)}` +
      `&detailLon=${encodeURIComponent(LON)}` +
      "&width=100%&height=100%" +
      "&zoom=9&level=surface" +
      "&overlay=rain" +
      "&product=ecmwf" +
      "&menu=&message=true&marker=true" +
      "&calendar=now&pressure=true" +
      "&type=map&location=coordinates&detail=true" +
      "&metricWind=default&metricTemp=default&radarRange=-1";

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);

    function setClock() {
      $("clock").textContent = new Date().toLocaleString();
    }

    function safe(v, fallback="—") {
      return (v === undefined || v === null || v === "") ? fallback : v;
    }

    function parseCeilingFromClouds(clouds) {
      if (!Array.isArray(clouds) || !clouds.length) return null;
      const candidates = clouds
        .filter(c => ["BKN","OVC","VV"].includes((c.cover || "").toUpperCase()) && Number.isFinite(c.base))
        .sort((a,b) => a.base - b.base);
      return candidates.length ? candidates[0].base : null; // feet
    }

    function formatCeilingLabel(clouds) {
      const base = parseCeilingFromClouds(clouds);
      if (base == null) return "—";
      const top = (clouds || []).find(c => ["BKN","OVC","VV"].includes((c.cover || "").toUpperCase()) && c.base === base);
      const cover = top?.cover || "CIG";
      return `${cover} ${base} ft`;
    }

    function computeAgeMinutes(isoTime) {
      if (!isoTime) return "—";
      const t = new Date(isoTime).getTime();
      if (!Number.isFinite(t)) return "—";
      const mins = Math.round((Date.now() - t) / 60000);
      return (mins >= 0) ? `${mins} min` : "—";
    }

    function fmtUnixLocal(unixSec) {
      if (!unixSec || !Number.isFinite(unixSec)) return "—";
      const d = new Date(unixSec * 1000);
      return d.toLocaleString([], { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function visToNumber(vis) {
      // Handles: 6+, "6+", 2, "2", null
      if (vis == null) return null;
      if (typeof vis === "string") {
        const s = vis.trim().replace("+", "");
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      }
      return Number.isFinite(vis) ? vis : null;
    }

    function flightCategoryFrom(visSM, ceilFT) {
      // Common thresholds:
      // LIFR:  <1 SM OR <500 ft
      // IFR:   1-<3 SM OR 500-<1000 ft
      // MVFR:  3-5 SM OR 1000-<3000 ft
      // VFR:   >5 SM AND >=3000 ft
      //
      // If one is missing, classify from the other when possible.
      const vis = (visSM == null) ? null : visSM;
      const ceil = (ceilFT == null) ? null : ceilFT;

      const visCat = (v) => {
        if (v == null) return null;
        if (v < 1) return "LIFR";
        if (v < 3) return "IFR";
        if (v <= 5) return "MVFR";
        return "VFR";
      };

      const ceilCat = (c) => {
        if (c == null) return null;
        if (c < 500) return "LIFR";
        if (c < 1000) return "IFR";
        if (c < 3000) return "MVFR";
        return "VFR";
      };

      const a = visCat(vis);
      const b = ceilCat(ceil);

      if (a && b) {
        // return the worse of the two
        const rank = { "LIFR":0, "IFR":1, "MVFR":2, "VFR":3 };
        return (rank[a] < rank[b]) ? a : b;
      }
      return a || b || "UNKNOWN";
    }

    function catToClass(cat) {
      switch ((cat || "").toUpperCase()) {
        case "VFR": return "cat-vfr";
        case "MVFR": return "cat-mvfr";
        case "IFR": return "cat-ifr";
        case "LIFR": return "cat-lifr";
        default: return "cat-unknown";
      }
    }

    async function fetchJSON(path) {
      const url = `${PROXY_BASE}${path}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    // ====== LOADERS ======
    async function loadMetar() {
      const metarraw = $("metarraw");
      metarraw.className = "mono cat-unknown";
      try {
        const arr = await fetchJSON(`/metar?ids=${encodeURIComponent(STATION)}`);
        const m = (Array.isArray(arr) && arr.length) ? arr[0] : null;
        if (!m) throw new Error("No METAR returned");

        // Raw string (field varies)
        const raw = safe(m.rawOb || m.raw || m.text, JSON.stringify(m, null, 2));
        metarraw.textContent = raw;

        // Decoded highlights
        $("fltcat").textContent = safe(m.fltCat);
        $("wind").textContent = safe(
          (m.wdir !== undefined && m.wspd !== undefined)
            ? `${m.wdir}° @ ${m.wspd} kt${m.wgst ? " G" + m.wgst : ""}`
            : "—"
        );
        $("vis").textContent = safe(m.visib !== undefined ? `${m.visib} sm` : "—");
        $("cig").textContent = formatCeilingLabel(m.clouds);
        $("tempdew").textContent = (m.temp !== undefined && m.dewp !== undefined)
          ? `${m.temp}°C / ${m.dewp}°C`
          : "—";
        $("altim").textContent = safe(m.altim !== undefined ? `A${m.altim}` : "—");

        const obs = m.obsTime || m.reportTime || m.time;
        $("obstime").textContent = safe(obs);
        $("age").textContent = computeAgeMinutes(obs);

        // Color METAR raw by category reported by the API
        const metCat = (m.fltCat || "UNKNOWN");
        metarraw.classList.add(catToClass(metCat));

      } catch (e) {
        metarraw.textContent = `ERROR loading METAR: ${e.message}`;
        metarraw.className = "mono error";
      }
    }

    function renderTafLines(t) {
      const holder = $("tafLines");
      holder.innerHTML = "";

      // Header: show raw TAF headline (optional)
      const rawTAF = t.rawTAF || t.rawOb || t.raw || t.text || "";
      $("tafrawheader").textContent = rawTAF ? "Raw TAF loaded (line colors below computed per group)." : "";

      if (!Array.isArray(t.fcsts) || !t.fcsts.length) {
        const d = document.createElement("div");
        d.className = "tafLine cat-unknown";
        d.innerHTML = `<div class="meta">No forecast groups returned</div><div class="txt mono">—</div>`;
        holder.appendChild(d);
        return;
      }

      // Build a colored line for each forecast group
      t.fcsts.forEach((f, idx) => {
        const chg = f.fcstChange ? f.fcstChange : (idx === 0 ? "BASE" : "CONT");
        const visN = visToNumber(f.visib);
        const ceil = parseCeilingFromClouds(f.clouds);

        const cat = flightCategoryFrom(visN, ceil);
        const cls = catToClass(cat);

        const wind = (f.wdir != null && f.wspd != null)
          ? `${String(f.wdir).padStart(3,"0")}${String(f.wspd).padStart(2,"0")}${f.wgst ? "G"+String(f.wgst).padStart(2,"0") : ""}KT`
          : "";

        const vis = (f.visib != null) ? `P${f.visib}SM`.replace("PP", "P") : ""; // light cleanup
        const wx = f.wxString ? f.wxString : "";

        // TAF-style ceiling token (OVC011)
        let cigTok = "";
        if (Array.isArray(f.clouds) && f.clouds.length) {
          const c = f.clouds.find(x => ["BKN","OVC","VV"].includes((x.cover || "").toUpperCase()) && Number.isFinite(x.base));
          if (c) cigTok = `${c.cover}${Math.round(c.base/100).toString().padStart(3,"0")}`;
        }

        const timeWin = `${fmtUnixLocal(f.timeFrom)}–${fmtUnixLocal(f.timeTo)}`;
        const lineTxt = [chg, timeWin, wind, (f.visib != null ? `${f.visib}SM` : ""), wx, cigTok].filter(Boolean).join(" ");

        const card = document.createElement("div");
        card.className = `tafLine ${cls}`;
        card.innerHTML = `
          <div class="meta">${cat} • ${chg}</div>
          <div class="txt mono">${lineTxt}</div>
        `;
        holder.appendChild(card);
      });
    }

    async function loadTaf() {
      const tafmeta = $("tafmeta");
      const holder = $("tafLines");
      holder.innerHTML = "";

      try {
        const arr = await fetchJSON(`/taf?ids=${encodeURIComponent(STATION)}`);
        const t = (Array.isArray(arr) && arr.length) ? arr[0] : null;
        if (!t) throw new Error("No TAF returned");

        tafmeta.textContent =
          `Issued: ${safe(t.issueTime)} • Bulletin: ${safe(t.bulletinTime)} • Valid: ${fmtUnixLocal(t.validTimeFrom)}–${fmtUnixLocal(t.validTimeTo)}`;

        renderTafLines(t);

      } catch (e) {
        tafmeta.textContent = "";
        const d = document.createElement("div");
        d.className = "tafLine";
        d.innerHTML = `<div class="meta error">ERROR loading TAF</div><div class="txt mono error">${e.message}</div>`;
        holder.appendChild(d);
      }
    }

    function init() {
      setClock();
      $("windy").src = WINDY_URL;

      loadMetar();
      loadTaf();

      setInterval(setClock, 1000 * 10);
      setInterval(loadMetar, 1000 * 60);       // METAR ~1 min
      setInterval(loadTaf,  1000 * 5 * 60);    // TAF ~5 min
    }

    init();
  </script>
</body>
</html>
